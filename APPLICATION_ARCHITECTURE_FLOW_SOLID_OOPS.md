# Application Flow, Architecture, SOLID and OOP Mapping

## 1) High-Level Architecture

The project follows a layered architecture:

1. `Controllers/` (Presentation Layer)
2. `TSCDB.Application/` (Application Layer: use-cases, DTOs, interfaces, mapping)
3. `TSCDB.Core/` (Domain Layer: entities, enums, repository contracts)
4. `TSCDB.Infrastructure/` (Infrastructure Layer: EF Core DbContext + repository implementations)

Primary runtime bootstrap happens in `Program.cs` through ASP.NET Core dependency injection.

---

## 2) End-to-End Request Flow

Example: Login flow

1. `Controllers/AuthController.cs` receives `POST /api/auth/login`.
2. Controller calls `IAuthService.LoginAsync(...)`.
3. DI resolves `TSCDB.Application.Features.Authentication.AuthService`.
4. `AuthService` loads user via `IUserRepository` (`TSCDB.Infrastructure.Repositories.UserRepository`).
5. `AuthService` creates response DTO using AutoMapper (`TSCDB.Application.Mappings.MappingProfile`) and JWT via `IJwtService`.
6. Response is returned by controller.

Example: Generic master CRUD flow

1. `Controllers/MastersController.cs` calls `IMasterService<T>`.
2. DI resolves generic `MasterService<T>`.
3. Service uses `IGenericRepository<T>` (DIP) + AutoMapper.
4. `GenericRepository<T>` executes EF Core operations via `TSCDbContext`.
5. DTO response returns to API layer.

---

## 3) Authentication/Authorization Flow

Files:

- `Controllers/AuthController.cs`
- `TSCDB.Application/Interfaces/IAuthService.cs`
- `TSCDB.Application/Features/Authentication/AuthService.cs`
- `TSCDB.Application/Features/Authentication/JwtService.cs`
- `TSCDB.Core/Domain/Authentication/*`
- `TSCDB.Infrastructure/Repositories/UserRepository.cs`

How it works:

1. Login verifies user credentials.
2. Token generated by `JwtService`.
3. Role/permission read from `Roles`, `Permissions`, `RolePermissions`.
4. `Program.cs` enables JWT bearer middleware.

---

## 4) Domain/Database Flow

Main persistence files:

- `TSCDB.Infrastructure/Data/Context/TSCDbContext.cs`
- `Migrations/*`

`TSCDbContext` defines `DbSet<>` and relationships (`OnModelCreating`), which EF migrations convert to SQL schema.

---

## 5) SOLID Principles Used (with file mapping)

### S - Single Responsibility Principle (SRP)

- `Controllers/AuthController.cs`: handles HTTP concerns only.
- `TSCDB.Application/Features/Authentication/AuthService.cs`: authentication business rules.
- `TSCDB.Infrastructure/Repositories/UserRepository.cs`: user-specific data access.
- `TSCDB.Application/Mappings/MappingProfile.cs`: object-object mapping configuration only.

### O - Open/Closed Principle (OCP)

- `TSCDB.Application/Features/Masters/MasterService.cs`: generic service reusable for new master entities without changing core logic.
- `TSCDB.Infrastructure/Repositories/GenericRepository.cs`: generic data access extended by specific repos.

### L - Liskov Substitution Principle (LSP)

- `TSCDB.Infrastructure/Repositories/UserRepository.cs : GenericRepository<User>, IUserRepository`
- `TSCDB.Infrastructure/Repositories/LoanRepository.cs : GenericRepository<Loan>, ILoanRepository`

These concrete repositories can be used where repository abstractions are expected.

### I - Interface Segregation Principle (ISP)

- `TSCDB.Application/Interfaces/IAuthService.cs`
- `TSCDB.Application/Interfaces/IMasterService.cs`
- `TSCDB.Core/Interfaces/Repositories/IUserRepository.cs`
- `TSCDB.Core/Interfaces/Repositories/IDealerRepository.cs`

Services/controllers depend on focused interfaces instead of one giant contract.

### D - Dependency Inversion Principle (DIP)

- `Program.cs` registers abstractions to implementations via DI.
- Controllers depend on service interfaces (`IAuthService`, `IDealerService`, etc.).
- Services depend on repository interfaces (`IUserRepository`, `IGenericRepository<T>`) rather than concrete EF classes.

---

## 6) OOP Concepts Used (with file mapping)

### Abstraction

- Interfaces: `IAuthService`, `IMasterService<T>`, `IGenericRepository<T>`, `IUserRepository`, etc.

### Encapsulation

- Business logic encapsulated in services (`AuthService`, `MasterService<T>`, `DealerService`, `LoanService`).
- Data access encapsulated in repositories (`GenericRepository<T>`, `UserRepository`, `DealerRepository`).

### Inheritance

- `UserRepository : GenericRepository<User>`
- `LoanRepository : GenericRepository<Loan>`

### Polymorphism

- Interface-based polymorphism through DI (`IAuthService` can be swapped by another implementation).
- Generic polymorphism in `GenericRepository<T>` and `MasterService<T>`.

### Composition

- `AuthService` composes dependencies: `IUserRepository`, `IJwtService`, `IEmailService`, etc.
- `TSCDbContext` composes many `DbSet<>` and entity relationships.

---

## 7) File Dependency Reference (key files)

1. `Program.cs`
   - Depends on: all interfaces/implementations registered in DI.
2. `Controllers/AuthController.cs`
   - Depends on: `IAuthService`, auth DTOs.
3. `TSCDB.Application/Features/Authentication/AuthService.cs`
   - Depends on: `IUserRepository`, `IDealerRepository`, `IDealerService`, `IJwtService`, `IEmailService`, `TSCDbContext`, AutoMapper.
4. `TSCDB.Infrastructure/Repositories/UserRepository.cs`
   - Depends on: `TSCDbContext`, `GenericRepository<User>`, `IUserRepository`.
5. `TSCDB.Application/Features/Masters/MasterService.cs`
   - Depends on: `IGenericRepository<T>`, AutoMapper, `IMasterEntity`.
6. `TSCDB.Infrastructure/Repositories/GenericRepository.cs`
   - Depends on: `TSCDbContext`, EF `DbSet<T>`.
7. `TSCDB.Infrastructure/Data/Context/TSCDbContext.cs`
   - Depends on: domain entities in `TSCDB.Core.Domain.*`.
8. `TSCDB.Application/Mappings/MappingProfile.cs`
   - Depends on: DTOs + Domain models.

---

## 8) Current Important Notes

1. Passwords are currently stored/compared as plain text in auth flow (`AuthService`). This should be replaced with hashing.
2. There are many nullable and precision warnings from build; compile succeeds but these should be hardened.
3. EF relationship for `Dealer.RelationshipManager` is configured then ignored in context; this is flagged by EF warnings and should be cleaned.
